@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Multi Player Form";
}

<div class="container mt-5">
    <h2 class="text-center mb-4">Select a Quiz for Multiplayer</h2>

    <form id="multiPlayerForm" action="@Url.Action("ProcessMultiplayerQuiz", "Admin")" method="post">

        <!-- Error message placeholder -->
        <div id="errorMessage" class="alert alert-danger d-none"></div>

        <div class="form-group">
            <label for="quizSelect">Select Quiz:</label>
            <select class="form-control" id="quizSelect" name="quizId" required>
                <option value="">Please select a quiz</option>
                @foreach (var quiz in Model)
                {
                    <option value="@quiz.QuizId">@quiz.QuizName</option>
                }
            </select>
        </div>
        <input name="__RequestVerificationToken" type="hidden" value="@Html.AntiForgeryToken()" />

        <div class="form-group">
            <label for="beginDateTime">Begin Date and Time:</label>
            <input type="datetime-local" class="form-control" id="beginDateTime" name="beginDateTime" required>
        </div>
        <div class="form-group">
            <label for="endDateTime">End Date and Time:</label>
            <input type="datetime-local" class="form-control" id="endDateTime" name="endDateTime" required>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Confirm Submission</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to submit the following quiz for multiplayer?</p>
                <div class="quiz-details">
                    <strong>Quiz:</strong> <span id="quizNameModal"></span><br>
                    <strong>Begin Date and Time:</strong> <span id="beginDateTimeModal"></span><br>
                    <strong>End Date and Time:</strong> <span id="endDateTimeModal"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSubmit">Yes, submit it</button>
            </div>
        </div>
    </div>
</div>
<div id="loadingIndicator" class="text-center d-none">
    <div class="spinner-border" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<!-- QR Code Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" role="dialog" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalLabel">QR Code</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <img id="qrImage" src="" alt="QR Code" class="img-fluid" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    $(document).ready(function () {
        var form = $('#multiPlayerForm');
        var isValidForm = false; // Variable to store the form's validity

        form.on('submit', function (e) {
            e.preventDefault(); // Prevent form submission

            var errorMessage = '';
            var quizId = $('#quizSelect').val();
            var quizName = $('#quizSelect option:selected').text();
            var beginDateTime = $('#beginDateTime').val();
            var endDateTime = $('#endDateTime').val();
            var now = new Date();

            // Convert to user's local time zone for comparison
            var beginDateTimeLocal = new Date(beginDateTime);
            var endDateTimeLocal = new Date(endDateTime);

            if (beginDateTimeLocal < now) {
                errorMessage = 'Begin date and time must be in the future.';
            } else if (endDateTimeLocal <= beginDateTimeLocal) {
                errorMessage = 'End date and time must be after the begin date and time.';
            }

            if (errorMessage !== '') {
                $('#errorMessage').text(errorMessage).removeClass('d-none');
            } else {
                // Hide and clear message, fill modal details, and show modal
                $('#errorMessage').addClass('d-none').text('');
                $('#quizNameModal').text(quizName);
                $('#beginDateTimeModal').text(beginDateTimeLocal.toLocaleString());
                $('#endDateTimeModal').text(endDateTimeLocal.toLocaleString());
                $('#confirmationModal').modal('show');
            }

            $('#loadingIndicator').removeClass('d-none');

            // Perform AJAX request
            

        });

        // Bind to confirm submission button
        $('#confirmSubmit').click(function () {
            var _quizId = $('#quizSelect').val();
            var _beginDateTime = $('#beginDateTime').val();
            var _endDateTime = $('#endDateTime').val();
            var now = new Date();

            // Convert to user's local time zone for comparison
            var beginDateTimeLocal = new Date(_beginDateTime);
            var endDateTimeLocal = new Date(_endDateTime);

            if (beginDateTimeLocal < now || endDateTimeLocal <= beginDateTimeLocal) {
                $('#confirmationModal').modal('hide');
                $('#errorMessage').removeClass('d-none').text('Invalid date and time provided.');
            } else {
                $.ajax({
                    url: '/Admin/ProcessMultiplayerQuiz', // Corrected URL
                    type: 'POST',
                    data: {
                        quizId: _quizId,
                        beginDateTime: _beginDateTime,
                        endDateTime: _endDateTime
                    },
                    headers: {
                        "RequestVerificationToken": $('input[name="__RequestVerificationToken"]').val() // Include CSRF token
                    },
                    success: function (response) {
                        if (response.Url) {
                            $('#qrImage').attr('src', response.Url);
                            $('#qrModal').modal('show');
                        } else {
                            $('#errorMessage').text('Failed to generate QR code').removeClass('d-none');
                        }
                    },
                    error: function () {
                        $('#errorMessage').text('An error occurred').removeClass('d-none');
                    }
                });
            }
        });


        // Bind to cancel button in modal to close modal
        $('.close, .btn-secondary').click(function () {
            $('#confirmationModal').modal('hide');
        });

        $('input, select').on('change', function () {
            // Optionally hide the error message when the user starts correcting the form
            $('#errorMessage').addClass('d-none').text('');
        });
    });

</script>
